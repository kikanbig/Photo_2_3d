# 🚂 Настройка PostgreSQL на Railway

## Шаги по подключению базы данных

### 1. Откройте ваш проект на Railway

Перейдите на https://railway.app и откройте проект `Photo_to_3D`

### 2. Добавьте PostgreSQL базу данных

1. В вашем проекте нажмите кнопку **"+ New"**
2. Выберите **"Database"**
3. Выберите **"Add PostgreSQL"**

Railway автоматически:
- Создаст контейнер PostgreSQL
- Сгенерирует безопасные учётные данные
- Создаст переменную `DATABASE_URL`

### 3. Подключите базу данных к сервису

1. Нажмите на ваш **backend сервис**
2. Перейдите на вкладку **"Variables"**
3. Railway автоматически добавит `DATABASE_URL` (если подключение настроено)

Если переменная не появилась автоматически:

1. Нажмите на **PostgreSQL базу данных**
2. Скопируйте `DATABASE_URL` из вкладки **"Variables"**
3. Вернитесь к **backend сервису** → **"Variables"**
4. Добавьте новую переменную:
   - Имя: `DATABASE_URL`
   - Значение: вставьте скопированный URL

### 4. Проверьте переменные окружения

Убедитесь, что в вашем сервисе установлены:

```
NODE_ENV=production
DATABASE_URL=postgresql://... (автоматически)
GENAPI_API_KEY=ваш_ключ
```

### 5. Пере-деплой приложения

После добавления базы данных:

1. Перейдите в **Deployments**
2. Нажмите **"Redeploy"** на последнем деплое
3. Или просто сделайте новый push в GitHub (автодеплой)

### 6. Проверка подключения

После деплоя проверьте логи:

1. Откройте **backend сервис**
2. Перейдите на вкладку **"Deployments"**
3. Откройте последний деплой
4. Проверьте логи на наличие:

```
✅ Подключение к базе данных установлено успешно
✅ Модели синхронизированы с базой данных
🚀 Сервер запущен на порту 3001
🗄️ База данных подключена
```

## Что происходит автоматически?

При первом запуске сервера с подключённой БД:

1. **Sequelize подключается к PostgreSQL**
   - Использует SSL для безопасности
   - Проверяет подключение

2. **Создаются таблицы автоматически**
   - Таблица `models_3d` для хранения 3D моделей
   - Все индексы и ограничения
   - Sequelize использует `sync({ alter: true })`

3. **Приложение готово к работе**
   - API `/api/models` доступно
   - Можно сохранять модели
   - Данные хранятся в PostgreSQL

## Мониторинг базы данных

Railway предоставляет встроенный мониторинг:

1. Откройте **PostgreSQL сервис**
2. Вкладки:
   - **"Metrics"** - графики использования (CPU, RAM, Disk, Connections)
   - **"Data"** - просмотр данных (требует pgAdmin или CLI)
   - **"Variables"** - строка подключения
   - **"Settings"** - настройки базы

### Метрики в реальном времени:

- **CPU Usage** - нагрузка на процессор
- **Memory Usage** - использование памяти
- **Disk Usage** - использование диска
- **Active Connections** - активные соединения

## Управление данными

### Просмотр данных через Railway CLI

```bash
# Установите Railway CLI
npm i -g @railway/cli

# Войдите в Railway
railway login

# Подключитесь к проекту
railway link

# Откройте PostgreSQL консоль
railway run psql $DATABASE_URL
```

### Базовые SQL команды

```sql
-- Показать все таблицы
\dt

-- Посмотреть структуру таблицы
\d models_3d

-- Показать все модели
SELECT id, name, status, "createdAt" FROM models_3d;

-- Количество моделей
SELECT COUNT(*) FROM models_3d WHERE status = 'active';

-- Выход
\q
```

## Резервное копирование

Railway автоматически делает backup, но вы можете создать свой:

```bash
# Экспорт базы данных
railway run pg_dump $DATABASE_URL > backup.sql

# Импорт базы данных
railway run psql $DATABASE_URL < backup.sql
```

## Troubleshooting

### ❌ Ошибка: "Unable to connect to database"

**Решение:**
1. Проверьте, что база данных запущена (зелёный статус в Railway)
2. Убедитесь, что `DATABASE_URL` установлен в переменных сервиса
3. Проверьте логи PostgreSQL на ошибки

### ❌ Ошибка: "SSL connection required"

**Решение:**
В `config/database.js` уже настроен SSL для production:
```javascript
dialectOptions: {
  ssl: process.env.NODE_ENV === 'production' ? {
    require: true,
    rejectUnauthorized: false
  } : false
}
```

### ❌ Таблицы не создаются

**Решение:**
1. Проверьте логи на ошибки Sequelize
2. Попробуйте redeploy
3. Убедитесь, что нет ошибок в модели `Model3D.js`

### ❌ Модели не сохраняются

**Решение:**
1. Откройте DevTools → Network
2. Проверьте запросы к `/api/models`
3. Посмотрите ответ сервера (должен быть `success: true`)
4. Проверьте логи backend на ошибки

## Ограничения Free Tier

Railway Free Tier включает:
- ✅ **512MB RAM** - достаточно для PostgreSQL + Backend
- ✅ **5GB Disk** - хранение моделей
- ✅ **$5/месяц** в кредитах (хватит на несколько моделей в день)

**Рекомендация:** Для production используйте платный план от $5/месяц.

## Масштабирование

Когда база данных вырастет:

1. **Upgrade плана PostgreSQL**
   - Settings → Change Plan
   - Больше RAM и Disk

2. **Оптимизация запросов**
   - Используйте пагинацию (`limit`, `offset`)
   - Добавьте кеширование (Redis)
   - Оптимизируйте индексы

3. **Архивирование старых моделей**
   - Используйте soft delete (`status: 'archived'`)
   - Переносите редко используемые модели в S3

## Следующие шаги

✅ База данных настроена  
✅ Приложение работает  
✅ Модели сохраняются в PostgreSQL  

**Готово к использованию! 🎉**

---

**Нужна помощь?**
- Railway Docs: https://docs.railway.app/databases/postgresql
- Наша документация: `DATABASE_SETUP.md`

